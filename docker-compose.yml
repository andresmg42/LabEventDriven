version: '3.8'

services:
  # Zookeeper - Required for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - microservices-net

  # Kafka Broker
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 5s
      timeout: 10s
      retries: 5
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'  
    networks:
      - microservices-net

  # Topic Initialization
  # kafka-init:
  #   image: confluentinc/cp-kafka:7.5.0
  #   container_name: kafka-init
  #   depends_on:
  #     kafka:
  #       condition: service_healthy
  #   entrypoint: [ '/bin/sh', '-c' ]
  #   command: |
  #     "
  #     # Create topics with proper configuration
  #     kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic user-events --partitions 3 --replication-factor 1
  #     kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic product-events --partitions 3 --replication-factor 1
  #     kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic inventory-events --partitions 3 --replication-factor 1
      
  #     echo 'âœ… Topics created successfully!'
  #     kafka-topics --bootstrap-server kafka:29092 --list
  #     "
  #   networks:
  #     - microservices-net

  # User Service - Produces user events
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "3001:3001"
    environment:
      - KAFKA_BROKER=kafka:29092
      - SERVICE_NAME=user-service
    networks:
      - microservices-net
    depends_on:
      # kafka-init:  
      #   condition: service_completed_successfully
      kafka:                                    
        condition: service_healthy

# Product Service - Produces product events
  product-service:
    build:
      context: ./product-service
      dockerfile: Dockerfile
    container_name: product-service
    ports:
      - "3002:3002"
    environment:
      - KAFKA_BROKER=kafka:29092
      - SERVICE_NAME=product-service
    networks:
      - microservices-net
    depends_on:
      # kafka-init:  
      #   condition: service_completed_successfully
      kafka:                                    
        condition: service_healthy

#inventory service
  inventory-service:
    build:
      context: ./inventory-service
      dockerfile: Dockerfile
    container_name: inventory-service
    ports:
      - "3003:3003"
    environment:
      - KAFKA_BROKER=kafka:29092
      - SERVICE_NAME=inventory-service
    networks:
      - microservices-net
    depends_on:
      # kafka-init:  
      #   condition: service_completed_successfully
      kafka:                                    
        condition: service_healthy

networks:
  microservices-net:
    driver: bridge